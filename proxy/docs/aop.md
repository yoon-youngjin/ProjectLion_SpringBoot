# AOP(Aspect-Oriented Programming)

부가 기능과 부가 기능을 어디에 적용할지 선택하는 기능을 합쳐서 하나의 모듈로 만들었는데, 이것이 바로 Aspect이다.
스프링이 제공하는 어드바이저도 어드바이스(부가 기능)과 포인트컷(적용 대상)을 가지고 있어서 개념상 하나의 Aspect이다.

Aspect는 우리말로 해석하면 관점이라는 뜻인데, 이름 그대로 애플리케이션을 바라보는 관점을 하나하나의 기능에서 횡단 관심사(cross-cutting concerns) 관점으로 달리 보는 것이다.
이러한 Aspect를 사용한 프로그래밍 방식을 관점 지향 프로그래밍 AOP(Aspect-Oriented Programming)이라한다.

> 참고로 AOP는 OOP를 대체하기 위한 것이 아닌 횡단 관심사를 깔끔하게 처리하기 어려운 OOP의 부족한 부분을 보조하는 목적으로 개발되었다.

<img width="573" alt="image" src="https://github.com/yoon-youngjin/spring-study/assets/83503188/9eb812c9-786b-4c1a-a831-6967463a83e9">

## AOP 적용 방식

AOP를 사용할 때 부가 기능 로직은 3가지 방식으로 실제 로직에 추가될 수 있다.
1. 컴파일 시점
2. 클래스 로딩 시점
3. 런타임 시점(프록시)

### 컴파일 시점 - 위빙

<img width="581" alt="image" src="https://github.com/yoon-youngjin/spring-study/assets/83503188/9887e428-eb45-4548-ae62-dfbac013de9e">

.java 소스 코드를 컴파일러를 사용해서 .class를 만드는 시점에 부가 기능 로직을 추가할 수 있다.
이때는 AspectJ가 제공하는 특별한 컴파일러를 사용해야 한다. 컴파일된 .class를 디컴파일 해보면 애스팩트 관련 호출 코드가 들어간다.

- 단점: 컴파일 시점에 부가 기능을 적용하려면 특별한 컴파일러가 필요하고 복잡해진다.

> 위빙: 위와 같이 원본 로직에 부가 기능 로직이 추가되는 것을 위빙(Weaving)이라 한다.

### 클래스 로딩 시점 - 위빙

<img width="579" alt="image" src="https://github.com/yoon-youngjin/spring-study/assets/83503188/ef15ec3e-496d-4b94-967c-5ec1181dec3b">

자바를 실행하면 자바 언어는 .class 파일을 JVM 내부의 클래스 로더에 보관한다. 이때 중간에서 .class 파일을 조작한 다음 JVM에 올릴 수 있다.
자바 언어는 .class를 JVM에 저장하기 전에 조작할 수 있는 기능을 제공한다.

- 단점: 로드 타임 위빙은 자바를 실행할 때 특별한 옵션(java - javaagent)을 통해 클래스 로더 조작기를 지정해야 하는데, 이 부분이 번거롭고 운영하기 어렵다.

> 참고로 많은 모니터링 툴들이 위와 같은 방식을 사용한다. 

### 런타임 시점 - 위빙

<img width="591" alt="image" src="https://github.com/yoon-youngjin/spring-study/assets/83503188/22ffdafe-fb8d-4d3c-9398-58bdd0b0a856">

런타임 시점은 컴파일도 다 끝나고, 클래스 로더에 클래스도 다 올라가서 이미 자바가 실행되고 난 다음을 말한다.
스프링과 같은 컨테이너의 도움을 받고 프록시와 DI, 빈 후처리기 같은 개념들을 총 동원해야 한다. 
이렇게 하면 최종적으로 프록시를 통해 스프링 빈에 부가 기능을 적용할 수 있지만 스프링이 반드시 필요하다.

프록시를 사용하기 때문에 AOP 기능에 일부 제약이 있다.
- final
- 생성자 호출 시점 제약 -> 메서드 호출만 가능

**AOP 적용 위치**
- 적용 가능 지점(JoinPoint): 생성자, 필드 값 접근, static 메서드 접근, 메서드 실행
  - 이렇게 AOP를 적용할 수 있는 지점을 조인 포인트라고 한다.
  - 단, 프록시를 사용함으로써 이에 대한 제약이 생긴다.
- 프록시 방식을 사용하는 스프링 AOP는 메서드 실행 시점에만 AOP를 적용할 수 있다.
  - 프록시는 메서드 오버라이딩 개념으로 동작한다. 따라서 생성자난 static 메서드, 필드 값 접근에는 프록시 개념을 적용할 수 없다.
- 프록시 방식을 사용하는 스프링 AOP는 스프링 컨테이너가 관리할 수 있는 스프링 빈에만 AOP를 적용할 수 있다.

## AOP 용어 정리

<img width="575" alt="image" src="https://github.com/yoon-youngjin/spring-study/assets/83503188/d2a0ff43-8113-4537-aa87-93911f3a409f">

**조인 포인트(Join point)**

- 어드바이스가 적용될 수 있는 위치, 메소드 실행, 생성자 호출, 필드 값 접근, static 메서드 접근 같은 프로그램 실행 중 지점
- 조인 포인트는 추상적인 개념이다. AOP를 적용할 수 있는 모든 지점이라 생각하면 된다.
- 스프링 AOP는 프록시 방식을 사용하므로 조인 포인트는 항상 메소드 실행 지점으로 제한된다.

**포인트컷(Pointcut)**

- 조인 포인트 중에서 어드바이스가 적용될 위치를 선별하는 기능
- 주로 AspectJ 표현식을 사용해서 지정
- 프록시를 사용하는 스프링 AOP는 메서드 실행 지점만 포인트컷으로 선별 가능

**타켓(Target)**

- 어드바이스를 받는 객체, 포인트컷으로 결정

**어드바이스(Advice)**

- 부가 기능
- 특정 조인 포인트에서 Aspect에 의해 취해지는 조치
- Around(주변), Before(전), After(후)와 같은 다양한 종류의 어드바이스가 있음

**애스펙트(Aspect)**

- 어드바이스 + 포인트컷을 모듈화 한 것
- `@Aspect` 를 생각하면 됨
- 여러 어드바이스와 포인트 컷이 함께 존재

**어드바이저(Advisor)**

- 하나의 어드바이스와 하나의 포인트 컷으로 구성
- 스프링 AOP에서만 사용되는 특별한 용어

**위빙(Weaving)**

- 포인트컷으로 결정한 타켓의 조인 포인트에 어드바이스를 적용하는 것
- 위빙을 통해 핵심 기능 코드에 영향을 주지 않고 부가 기능을 추가 할 수 있음
- AOP 적용을 위해 애스펙트를 객체에 연결한 상태
- 컴파일 타임(AspectJ compiler)
- 로드 타임
- 런타임, 스프링 AOP는 런타임, 프록시 방식

**AOP 프록시**

- AOP 기능을 구현하기 위해 만든 프록시 객체, 스프링에서 AOP 프록시는 JDK 동적 프록시 또는 CGLIB 프록시이다.